#!/usr/bin/python3
# Read in backups of /etc/passwd, group, shadow, gshadow and create new versions

import sys
import os

MIN_IMPORT_UID = 1000
USERNAMES_EXCLUDED = ['nobody', 'root']
GROUPNAMES_EXCLUDED = ['nobody', 'root', 'wheel']

def main():
    basedir = os.getcwd()

    seen_gids = []
    seen_users = []
    seen_groups = []

    with open('passwd', 'r') as passwdfile, open('passwd_to_append.txt', 'w') as outputfile:
        for line in passwdfile:
            data = line.strip().split(':')
            uid = int(data[2])
            gid = int(data[3])
            username = data[0]
            #print("uid: {}, username: {}".format(uid, username))
            if not username in USERNAMES_EXCLUDED:
                if uid >= MIN_IMPORT_UID:
                    seen_users.append(username)
                    seen_gids.append(gid)
                    outputfile.write(line)

    with open('shadow', 'r') as shadowfile, open('shadow_to_append.txt', 'w') as outputfile:
        for line in shadowfile:
            data = line.strip().split(':')
            username = data[0]
            if username in seen_users:
                outputfile.write(line)

    with open('group', 'r') as groupfile, open('group_to_append.txt', 'w') as outputfile:
        for line in groupfile:
            data = line.strip().split(':')
            groupname = data[0]
            gid = int(data[2])
            if not groupname in GROUPNAMES_EXCLUDED:
                if gid >= MIN_IMPORT_UID or gid in seen_gids:
                    seen_groups.append(groupname)
                    outputfile.write(line)

    with open('gshadow', 'r') as gshadowfile, open('gshadow_to_append.txt', 'w') as outputfile:
        for line in gshadowfile:
            data = line.strip().split(':')
            groupname = data[0]
            if groupname in seen_groups:
                outputfile.write(line)

if __name__ == "__main__":
    main()